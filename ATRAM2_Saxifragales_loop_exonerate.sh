#!/bin/bash
myaTRAMfile='best';  
summaryfile='Saxifragales_lowcopynuclear';  
mypath='/srv/gspeedq32/ryanfolk/new_atram2_postprocessing/final_all_combined'; # leave off last "/" of path
pathtoreference='/srv/gspeedq32/ryanfolk/new_atram2_postprocessing/ref_prot';
myoverlap='10';

# This list already takes into account some but not all suppressed taxa
array=(P01_WA1 P01_WA10 P01_WA11 P01_WA12 P01_WA2 P01_WA3 P01_WA4 P01_WA5 P01_WA6 P01_WA7 P01_WA8 P01_WA9 P01_WB1 P01_WB10 P01_WB11 P01_WB12 P01_WB2 P01_WB3 P01_WB4 P01_WB5 P01_WB6 P01_WB7 P01_WB8 P01_WB9 P01_WC1 P01_WC10 P01_WC11 P01_WC12 P01_WC2 P01_WC3 P01_WC4 P01_WC5 P01_WC6 P01_WC7 P01_WC8 P01_WC9 P01_WD1 P01_WD10 P01_WD11 P01_WD12 P01_WD2 P01_WD3 P01_WD4 P01_WD5 P01_WD6 P01_WD7 P01_WD8 P01_WD9 P01_WE1 P01_WE10 P01_WE11 P01_WE12 P01_WE2 P01_WE3 P01_WE4 P01_WE5 P01_WE6 P01_WE7 P01_WE8 P01_WE9 P01_WF1 P01_WF10 P01_WF11 P01_WF12 P01_WF2 P01_WF3 P01_WF4 P01_WF5 P01_WF6 P01_WF7 P01_WF8 P01_WF9 P01_WG1 P01_WG10 P01_WG11 P01_WG12 P01_WG2 P01_WG3 P01_WG4 P01_WG5 P01_WG6 P01_WG7 P01_WG8 P01_WG9 P01_WH1 P01_WH10 P01_WH11 P01_WH12 P01_WH2 P01_WH3 P01_WH4 P01_WH5 P01_WH6 P01_WH7 P01_WH8 P01_WH9 P02_WA1 P02_WA10 P02_WA11 P02_WA12 P02_WA2 P02_WA3 P02_WA4 P02_WA5 P02_WA6 P02_WA7 P02_WA8 P02_WA9 P02_WB1 P02_WB10 P02_WB11 P02_WB12 P02_WB2 P02_WB3 P02_WB4 P02_WB5 P02_WB6 P02_WB7 P02_WB8 P02_WB9 P02_WC1 P02_WC10 P02_WC11 P02_WC12 P02_WC2 P02_WC3 P02_WC4 P02_WC5 P02_WC6 P02_WC7 P02_WC8 P02_WC9 P02_WD1 P02_WD10 P02_WD11 P02_WD12 P02_WD2 P02_WD3 P02_WD4 P02_WD5 P02_WD6 P02_WD7 P02_WD8 P02_WD9 P02_WE1 P02_WE10 P02_WE11 P02_WE12 P02_WE2 P02_WE3 P02_WE4 P02_WE5 P02_WE6 P02_WE7 P02_WE8 P02_WE9 P02_WF1 P02_WF10 P02_WF11 P02_WF12 P02_WF2 P02_WF3 P02_WF4 P02_WF5 P02_WF6 P02_WF7 P02_WF8 P02_WF9 P02_WG1 P02_WG10 P02_WG11 P02_WG12 P02_WG2 P02_WG3 P02_WG4 P02_WG5 P02_WG6 P02_WG7 P02_WG8 P02_WG9 P02_WH1 P02_WH10 P02_WH11 P02_WH12 P02_WH2 P02_WH3 P02_WH4 P02_WH5 P02_WH6 P02_WH7 P02_WH8 P02_WH9 P03_WA1 P03_WA10 P03_WA11 P03_WA12 P03_WA2 P03_WA3 P03_WA4 P03_WA5 P03_WA6 P03_WA7 P03_WA8 P03_WA9 P03_WB1 P03_WB10 P03_WB11 P03_WB12 P03_WB2 P03_WB3 P03_WB4 P03_WB5 P03_WB6 P03_WB7 P03_WB8 P03_WB9 P03_WC1 P03_WC10 P03_WC11 P03_WC12 P03_WC2 P03_WC3 P03_WC4 P03_WC5 P03_WC6 P03_WC7 P03_WC8 P03_WC9 P03_WD1 P03_WD10 P03_WD11 P03_WD12 P03_WD2 P03_WD3 P03_WD4 P03_WD5 P03_WD6 P03_WD7 P03_WD8 P03_WD9 P03_WE1 P03_WE10 P03_WE11 P03_WE12 P03_WE2 P03_WE3 P03_WE4 P03_WE5 P03_WE6 P03_WE7 P03_WE8 P03_WE9 P03_WF1 P03_WF10 P03_WF11 P03_WF12 P03_WF2 P03_WF3 P03_WF4 P03_WF5 P03_WF6 P03_WF7 P03_WF8 P03_WF9 P03_WG1 P03_WG10 P03_WG11 P03_WG12 P03_WG2 P03_WG3 P03_WG4 P03_WG5 P03_WG6 P03_WG7 P03_WG8 P03_WG9 P03_WH1 P03_WH10 P03_WH11 P03_WH12 P03_WH2 P03_WH3 P03_WH4 P03_WH5 P03_WH6 P03_WH7 P03_WH8 P03_WH9 P04_WA1 P04_WA10 P04_WA11 P04_WA12 P04_WA2 P04_WA3 P04_WA4 P04_WA5 P04_WA6 P04_WA7 P04_WA8 P04_WA9 P04_WB1 P04_WB10 P04_WB11 P04_WB12 P04_WB2 P04_WB3 P04_WB4 P04_WB5 P04_WB6 P04_WB7 P04_WB8 P04_WB9 P04_WC1 P04_WC10 P04_WC11 P04_WC12 P04_WC2 P04_WC3 P04_WC4 P04_WC5 P04_WC6 P04_WC7 P04_WC8 P04_WC9 P04_WD1 P04_WD10 P04_WD11 P04_WD12 P04_WD2 P04_WD3 P04_WD4 P04_WD5 P04_WD6 P04_WD7 P04_WD8 P04_WD9 P04_WE1 P04_WE10 P04_WE11 P04_WE12 P04_WE2 P04_WE3 P04_WE4 P04_WE5 P04_WE6 P04_WE7 P04_WE8 P04_WE9 P04_WF1 P04_WF10 P04_WF11 P04_WF12 P04_WF2 P04_WF3 P04_WF4 P04_WF5 P04_WF6 P04_WF7 P04_WF8 P04_WF9 P04_WG1 P04_WG10 P04_WG11 P04_WG12 P04_WG2 P04_WG3 P04_WG4 P04_WG5 P04_WG6 P04_WG7 P04_WG8 P04_WG9 P04_WH1 P04_WH10 P04_WH11 P04_WH12 P04_WH2 P04_WH3 P04_WH4 P04_WH5 P04_WH6 P04_WH7 P04_WH8 P04_WH9 P05_WA1 P05_WA10 P05_WA11 P05_WA12 P05_WA2 P05_WA3 P05_WA4 P05_WA5 P05_WA6 P05_WA7 P05_WA8 P05_WA9 P05_WB1 P05_WB10 P05_WB11 P05_WB12 P05_WB2 P05_WB3 P05_WB4 P05_WB5 P05_WB6 P05_WB7 P05_WB8 P05_WB9 P05_WC1 P05_WC10 P05_WC11 P05_WC12 P05_WC2 P05_WC3 P05_WC4 P05_WC5 P05_WC6 P05_WC7 P05_WC8 P05_WC9 P05_WD1 P05_WD10 P05_WD11 P05_WD12 P05_WD2 P05_WD3 P05_WD4 P05_WD5 P05_WD6 P05_WD7 P05_WD8 P05_WD9 P05_WE1 P05_WE10 P05_WE11 P05_WE12 P05_WE2 P05_WE3 P05_WE4 P05_WE5 P05_WE6 P05_WE7 P05_WE8 P05_WE9 P05_WF1 P05_WF10 P05_WF11 P05_WF12 P05_WF2 P05_WF3 P05_WF4 P05_WF5 P05_WF6 P05_WF7 P05_WF8 P05_WF9 P05_WG1 P05_WG10 P05_WG11 P05_WG12 P05_WG2 P05_WG3 P05_WG4 P05_WG5 P05_WG6 P05_WG7 P05_WG8 P05_WG9 P05_WH1 P05_WH10 P05_WH11 P05_WH12 P05_WH2 P05_WH3 P05_WH4 P05_WH5 P05_WH6 P05_WH7 P05_WH8 P05_WH9 P06_WA1 P06_WA10 P06_WA11 P06_WA12 P06_WA2 P06_WA3 P06_WA4 P06_WA5 P06_WA6 P06_WA7 P06_WA8 P06_WA9 P06_WB1 P06_WB10 P06_WB11 P06_WB12 P06_WB2 P06_WB3 P06_WB4 P06_WB5 P06_WB6 P06_WB7 P06_WB8 P06_WB9 P06_WC1 P06_WC10 P06_WC11 P06_WC12 P06_WC2 P06_WC3 P06_WC4 P06_WC5 P06_WC6 P06_WC7 P06_WC8 P06_WC9 P06_WD1 P06_WD10 P06_WD11 P06_WD12 P06_WD2 P06_WD3 P06_WD4 P06_WD5 P06_WD6 P06_WD7 P06_WD8 P06_WD9 P06_WE1 P06_WE10 P06_WE11 P06_WE12 P06_WE2 P06_WE3 P06_WE4 P06_WE5 P06_WE6 P06_WE7 P06_WE8 P06_WE9 P06_WF1 P06_WF10 P06_WF11 P06_WF12 P06_WF2 P06_WF3 P06_WF4 P06_WF5 P06_WF6 P06_WF7 P06_WF8 P06_WF9 P06_WG1 P06_WG10 P06_WG11 P06_WG12 P06_WG2 P06_WG3 P06_WG4 P06_WG5 P06_WG6 P06_WG7 P06_WG8 P06_WG9 P06_WH1 P06_WH10 P06_WH11 P06_WH12 P06_WH2 P06_WH3 P06_WH4 P06_WH5 P06_WH6 P06_WH7 P06_WH8 P06_WH9 P07_WA1 P07_WA10 P07_WA11 P07_WA12 P07_WA2 P07_WA3 P07_WA4 P07_WA5 P07_WA6 P07_WA7 P07_WA8 P07_WA9 P07_WB1 P07_WB10 P07_WB11 P07_WB12 P07_WB2 P07_WB3 P07_WB4 P07_WB5 P07_WB6 P07_WB7 P07_WB8 P07_WB9 P07_WC1 P07_WC10 P07_WC11 P07_WC12 P07_WC2 P07_WC3 P07_WC4 P07_WC5 P07_WC6 P07_WC7 P07_WC8 P07_WC9 P07_WD1 P07_WD10 P07_WD11 P07_WD12 P07_WD2 P07_WD3 P07_WD4 P07_WD5 P07_WD6 P07_WD7 P07_WD8 P07_WD9 P07_WE1 P07_WE10 P07_WE11 P07_WE12 P07_WE2 P07_WE3 P07_WE4 P07_WE5 P07_WE6 P07_WE7 P07_WE8 P07_WE9 P07_WF1 P07_WF10 P07_WF11 P07_WF12 P07_WF2 P07_WF3 P07_WF4 P07_WF5 P07_WF6 P07_WF7 P07_WF8 P07_WF9 P07_WG1 P07_WG10 P07_WG11 P07_WG12 P07_WG2 P07_WG3 P07_WG4 P07_WG5 P07_WG6 P07_WG7 P07_WG8 P07_WG9 P07_WH1 P07_WH10 P07_WH11 P07_WH12 P07_WH2 P07_WH3 P07_WH4 P07_WH5 P07_WH6 P07_WH7 P07_WH8 P07_WH9 Liquidambar_formosana LMVB TOKV NUZN KWGC DRIL ZJUL FYTP IUSR YHXT HQRJ UWFU HTIP CKKR UHBY YKFU FCBJ OOVX CTSS SLOI Ampelopsis_cordata Cayratia_japonica Cissus_antarctica BGZG Leea_guineensis Parthenocissus_vitacea BBBA SZPD cynomorium AYMT IANR IPWB PXYR SVVG UDUT VKGP)

# Make sure files look like: P01_WE2_Locus104.best.ed.fasta

########################################################################################

#step 1
echo "step 1, running editbestfiles";
editbestfiles.pl;
echo "done with step 1";

#step 2
echo "step 2, running exonerate the first time";
for myref in $pathtoreference\/*.fasta;
do
for lib in ${array[@]};
do
mygene=`expr match "$myref" '.*\(Locus[0-9]*\)'`;
exonerate --model protein2genome $myref $mypath/$lib\_$mygene.$myaTRAMfile.ed.fasta --showvulgar no --showalignment no --ryo "$mygene,$lib,%ql,%qal,%qab,%qae,abyss,%ti\n" >> $mygene.results.out;
done;
fix_csv.pl $mygene.results.out $mygene.results.csv;
LC_ALL=C sort -t, -k 1,1d -k 6,6d -k 4,4n $mygene.results.csv > $mygene.results.sorted.csv;
done;
echo "done with step 2";

#step 2 and three-quarters
echo "step 2 and three-quarters, removing paralogous overlaps before stitching";
./paralog_stitch.py
echo "done with step 2 and three-quarters";

#step 3
echo "step 3, running first get contigs";
getcontigs.first.pl;
echo "done with step 3";

##step 4
echo "step 4, stitching";
stitch.aTRAM.contigs.pl  $myoverlap $myaTRAMfile $mypath;
echo "done with step 4";

#step 5
echo "step 5, getting summary data";
summarystats.first.pl > $summaryfile.txt;
echo "done with step 5";

#step 6
echo "step 6, running exonerate for second time";
for secref in $pathtoreference\/*.fasta; 
do
secgene=`expr match "$secref" '.*\(Locus[0-9]*\)'`;
exonerate --model protein2genome $secref $secgene.aTRAM.Exonerate.Round1.OVERLAP.10.fasta  --showvulgar no --showalignment no --ryo "$secgene,%ql,%qal,%qab,%qae,abyss,%ti\n" >> $secgene.exonerate2.out;
fix_csv.pl $secgene.exonerate2.out $secgene.exonerate2.csv; 
LC_ALL=C sort -t, -k 1,1d -k 6,6d -k 4,4n $secgene.exonerate2.csv > $secgene.exonerate2.csv.sorted;
done;

for thiref in $pathtoreference\/*.fasta;
do
thigene=`expr match "$thiref" '.*\(Locus[0-9]*\)'`;
exonerate --model protein2genome $thiref $thigene.aTRAM.Exonerate.Round1.OVERLAP.10.fasta  --showvulgar no --showalignment no --verbose 0 --ryo ">$thigene,abyss,%ti,%qab,%qae\n%tcs\n" >> $thigene.exonerate2.fasta;
done;

editcontigs.pl;
echo "done with step 6";

#step 7
echo "step 7, running second get contigs";
getcontigs.second.pl;
echo "done with step 7";

#step 8
echo "step 8, stitching exonerate contigs";
stitch.Exonerate.contigs.pl;
echo "done with step 8";

##step 9
echo "step 9, generating summary data for the final time";
summarystats.second.pl >> $summaryfile.txt;
echo "done with step 9";
